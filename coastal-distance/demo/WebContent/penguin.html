<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="KB GeoRisk distance to coast calculation demonstration">
    <meta name="author" content="Steve Perkins, KB GeoRisk">

    <title>KB GeoRisk</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
	
	<link href="css/kbgeo.css" rel="stylesheet">
	
	<style>
		.map-label {
			color: black;
			background-color: white;
			font-size: 12px;
			font-weight: bold;
			text-align: center;
			width: 150px;
			border: 1px solid #464646;
			white-space: nowrap;
			
			-webkit-border-radius: 2px 0px 2px 0px;
			-moz-border-radius: 2px 0px 2px 0px;
			border-radius: 2px 0px 2px 0px;
		}
	</style>
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <div id="wrapper" class="toggled">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="http://www.kbgeo.com">
                       <img src="img/kbgeo-logo.png" /> KB GeoRisk
                    </a>
                </li>
			</ul>
			

		    <div role="tabpanel" class="tab-pane active" id="addressTab" style="margin-top: 100px">
		    	<div class="form">
				  <div class="form-group">
					<label for="address">Addresses:</label>
					<textarea class="form-control" id="address" rows="10"></textarea>
				  </div>
				  <button id="address-go" type="button" class="btn btn-primary center-block" onclick="addressFormSubmit();return">Go!</button>
			  </div>
		    </div>
		    <div style="text-align: center">
		    	<span id="errorMessage"></span>
		    </div>
		    
			<div id="stats">
				<span class="responseTime"></span>
			</div>
			
			<div id="freeTrial">
				<a href="http://www.kbgeo.com/#contact">Get your free trial key now!</a>
			</div>
			
			<script async src="http://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js"></script>
			<ins class="adsbygoogle"
				 style="display:block"
				 data-ad-client="ca-pub-7895580917389214"
				 data-ad-slot="8585174130"
				 data-ad-format="auto"></ins>
			<script>
			(adsbygoogle = window.adsbygoogle || []).push({});
			</script>
				
            <div id="footer">
            	KB GeoRisk provides <strong>blazing-fast</strong>, <strong>highly-accurate</strong>, <strong>low-cost</strong> distance to coast calculation for insurance risk and other industries.
            	<div style="margin-top: 20px">
	            	<img src="img/firefox.png" /> <a id="firefox-warning" href="#" style="color: white">Firefox user?</a>
	            	<div id="firefox-warning-text" style="display: none">Firefox's March 2015 update disables CORS support. You may need to change your Firefox settings to enable CORS or use another browser.</div>
            	</div>
            </div>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
		<div id="mainMap" class="full-map"></div>
        </div>

    </div>

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCByV51ctBx5oDi6cbXTnfN7eBR2rUMGpE"></script>
    <script src="js/markerwithlabel.js"></script>
	
	<script src="js/validator.js"></script>
	<script src="js/maps-penguin.js"></script>
	
    <!-- Menu Toggle Script -->
    <script>
	var ROOT = "https://api.kbgeo.com";
	//var ROOT = "http://localhost:8080/api";
	var authToken = "vRt2zfxNF3";
	var map;
	var originPoint;
	var coastalPoint;
	
	$(window).on('resize orientationChange', function(event) {
		resetMapSize();
	});
	
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    
    $("#firefox-warning").click(function(e) {
        e.preventDefault();
        $("#firefox-warning-text").toggle();
    });
    
    
	
	function googleMapLibraryLoaded() {
		setTimeout(function() {$("#wrapper").toggleClass("toggled");}, 1);
		resetMapSize();
		map = initMap('mainMap');
	}
	
	function resetMapSize() {
		$(".full-map").height(document.documentElement.clientHeight);
	}
	
	// Marks an element as invalid. Takes a jQuery-ized DOM element as input.
	function markInvalid(element) {
		element.addClass('error');
	}
	
	// Marks an element as invalid. Takes a jQuery-ized DOM element as input.
	function markValid(element) {
		element.removeClass('error');
	}
	
	function resetLatLngValidity() {
		markValid($("#lat"));
		markValid($("#lng"));
		clearError();
	}
	
	function resetAddressValidity() {
		markValid($("#address"));
		clearError();
	}
	
	// Validates input and returns address string
	function addressFormValidateAndParse() {
		resetAddressValidity();
		
		var hasError = false;
		var addressControl = $("#address");
		var address = addressControl.val();
		if(!address || address.length <= 3) {
			// No way this is a valid address
			hasError = true;
			markInvalid(addressControl);
		}
		
		if(hasError) {
			return null;
		} else {
			var citiesAndStates = address.split("\n");
			
			var finalResult = [];
			var i = 0;
			for(i; i < citiesAndStates.length; i++) {
				// Split again to get city distinct from state
				var splittoon = citiesAndStates[i].split(", ");
				finalResult.push({ city: splittoon[0], state: splittoon[1] });
			}
			return finalResult;
		}
	}
	function addressFormSubmit() {
		var citiesAndStates = addressFormValidateAndParse();
		
		if(null == address) return;		
		
		for(var i = 0; i < citiesAndStates.length; i++) {
			// Throw an ajax call to geolocate and get the nearest coastal point and distance
			dropMarker(citiesAndStates[i]);
			
		}
	}
	
	function dropMarker(cityState) {
		$.ajax({
			type: 'GET',
			url: ROOT + "/coastal-distance/v1/address?address=" + cityState.city + ", " + cityState.state,
			headers: {
				"kb-auth-token": authToken
			},
			contentType: 'text/plain'
		}).error(function(jqXHR, textStatus, errorThrown) {
			console.error("Could not get coastal distance for address: " + errorThrown);
			if(jqXHR.responseJSON && jqXHR.responseJSON.error) {
				console.error(jqXHR.responseJSON.error);
				showError(jqXHR.responseJSON.error);
				return;
			}
		}).done(function(data) { 
			if(data.error) {
				showError(data.error);
				return;
			}
			
			createOriginPointMarker(map, data.targetPoint, data.distanceInMiles, cityState);
			createCoastalPointMarker(map, data.coastlinePoint);
			
			drawLineBetween(data.targetPoint, data.coastlinePoint, map);
		});
	}
	function round(num) {
		return Math.round(num * 100) / 100;
	}
	
	function roundToThreePlaces(num) {
		return Math.round(num * 1000) / 1000;
	}
	
	function validateLatIncremental(e) {
		e = e||window.event; // IE support
		var c = (e.keyCode ? e.keyCode : e.which);
		var ctrlDown = e.ctrlKey||e.metaKey; // Mac support

		// Prevent upper-case characters (symbols on number keys)
		if(e.keyIdentifier && e.keyIdentifier === "Shift") return false;
		
		// Check for Alt+Gr (http://en.wikipedia.org/wiki/AltGr_key)
		if (ctrlDown && e.altKey) return true;

		// Check for ctrl+c, v and x
		if (ctrlDown && c==67) return true; // c
		if (ctrlDown && c==86) return true; // v
		if (ctrlDown && c==88) return true; // x
		if (ctrlDown && c==88) return true; // x
		if (ctrlDown && c==91) return true; // y
		if (ctrlDown && c==90) return true; // z
		
		var code = String.fromCharCode((96 <= c && c <= 105)? c-48 : c);
		
		var element = $("#lat");
    	var val = element.val();
    	if(validateCoordinateCharacter(code)) {
    		return true;
    	}
    	return false;
    }
	
	function validateLngIncremental(e) {
		e = e||window.event; // IE support
		var c = (e.keyCode ? e.keyCode : e.which);
		var ctrlDown = e.ctrlKey||e.metaKey; // Mac support
		
		// Prevent upper-case characters (symbols on number keys)
		if(e.keyIdentifier && e.keyIdentifier === "Shift") return false;
		
		// Check for Alt+Gr (http://en.wikipedia.org/wiki/AltGr_key)
		if (ctrlDown && e.altKey) return true;

		// Check for ctrl+c, v and x
		if (ctrlDown && c==67) return true; // c
		if (ctrlDown && c==86) return true; // v
		if (ctrlDown && c==88) return true; // x
		if (ctrlDown && c==91) return true; // y
		if (ctrlDown && c==90) return true; // z
		
		
		var code = String.fromCharCode((96 <= c && c <= 105)? c-48 : c);
		
		var element = $("#lng");
    	var val = element.val();
    	if(validateCoordinateCharacter(code)) {
    		return true;
    	}
    	return false;
    }
	
	function showError(msg) {
		var errorElement = $("#errorMessage");
		errorElement.html(msg);
		errorElement.show();
	}
	
	function clearError(msg) {
		var errorElement = $("#errorMessage");
		errorElement.hide();
		errorElement.html("");
	}
	
	var responseTimeMs = 0;
	var requestSendTime;
	function markRequestSendTime() {
		requestSendTime = new Date().getTime();
	}
	
	var responseReceivedTime;
	function markResponseReceivedTime() {
		responseReceivedTime = new Date().getTime();
		responseTimeMs = responseReceivedTime - requestSendTime;
	}
	
	function getResponseTimeMs() { return responseTimeMs; }
	
	function showResponseTime() {
		$("#stats .responseTime").text("Time: " + responseTimeMs + "ms");
	}
	
	function showStats() {
		showResponseTime();
	}

	$( document ).ready(function() {
		googleMapLibraryLoaded();
		$("#lat, #lng").on("keydown",function search(e) {
		    if(e.keyCode == 13) {
		        $("#go").click();
		    }
	    });
		$("#address").on("keydown",function search(e) {
		    if(e.keyCode == 13) {
		        $("#address-go").click();
		    }
	    });
	});
    </script>

	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106137563-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-106137563-1');
	</script>
</body>

</html>
