<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="KB Geo distance to fire station API demonstration">
    <meta name="author" content="Steve Perkins, KB Geo">

    <title>KB Geo Distance to Fire Station Demo</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
	
	<link href="css/kbgeo.css" rel="stylesheet">
	
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->
</head>

<body>
    <div id="wrapper" class="toggled">
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="http://www.kbgeo.com/fire.html">
                       <img src="img/kbgeo-logo.png" /> KB GeoRisk
                    </a>
                </li>
			</ul>
			
			
            <ul class="nav nav-tabs" role="tablist">
			    <li role="presentation" class="active"><a href="#latlng" aria-controls="latlng" role="tab" data-toggle="tab">Lat/Lng</a></li>
			    <li role="presentation"><a href="#addressTab" aria-controls="addressTab" role="tab" data-toggle="tab">Address</a></li>
			  </ul>
			
			  <!-- Tab panes -->
			  <div class="tab-content">
			    <div role="tabpanel" class="tab-pane active" id="latlng">
			    	<div class="form">
					  <div class="form-group">
						<label for="lat">Lat:</label>
						<input type="text" class="form-control" id="lat" placeholder="Latitude" value="39.768403" onkeydown="return validateLatIncremental(event);">
					  </div>
					  <div class="form-group">
						<label for="lng">Lon:</label>
						<input type="text" class="form-control" id="lng" placeholder="Longitude" value="-86.158068" onkeydown="return validateLngIncremental(event);">
					  </div>
					  <button id="go" type="button" class="btn btn-primary center-block" onclick="latlngFormSubmit();return">Go!</button>
				  </div>
				</div>
			    <div role="tabpanel" class="tab-pane" id="addressTab">
			    	<div class="form">
					  <div class="form-group">
						<label for="address">Address:</label>
						<input type="text" class="form-control" id="address" placeholder="Full address" value="">
					  </div>
					  <button id="address-go" type="button" class="btn btn-primary center-block" onclick="addressFormSubmit();return">Go!</button>
				  </div>
			    </div>
			    <div style="text-align: center">
			    	<span id="errorMessage"></span>
			    </div>
			  </div>
			<div id="stats">
				<span class="responseTime"></span>
			</div>
			<div id="freeTrial" style="text-align: center;">
				<a href="http://www.kbgeo.com/fire.html#contact" style="color: #00ff00">Get your free trial key now!</a>
			</div>
            <div id="footer">
            	KB GeoRisk provides <strong>blazing-fast</strong>, <strong>easy-to-use</strong>, <strong>low-cost</strong> distance to fire station calculation for insurance risk and other industries.
            	<div style="margin-top: 20px">
	            	<img src="img/firefox.png" /> <a id="firefox-warning" href="#" style="color: white">Firefox user?</a>
	            	<div id="firefox-warning-text" style="display: none">Firefox's March 2015 update disables CORS support. You may need to change your Firefox settings to enable CORS or use another browser.</div>
            	</div>
            </div>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
		<div id="mainMap" class="full-map"></div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCByV51ctBx5oDi6cbXTnfN7eBR2rUMGpE"></script>
    <script src="js/markerwithlabel.js"></script>
	
	<script src="js/validator.js"></script>
	<script src="js/maps.js"></script>
	
    <!-- Menu Toggle Script -->
    <script>
	var ROOT = "https://api.kbgeo.com";
	//var ROOT = "http://localhost:8080/api";
	var authToken = "mNW93W1@pA";
	var map;
	var originPoint;
	var fireStationPoint;
	
	$(window).on('resize orientationChange', function(event) {
		resetMapSize();
	});
	
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    
    $("#firefox-warning").click(function(e) {
        e.preventDefault();
        $("#firefox-warning-text").toggle();
    });
    
    
	
	function googleMapLibraryLoaded() {
		setTimeout(function() {$("#wrapper").toggleClass("toggled");}, 1);
		resetMapSize();
		map = initMap('mainMap');
	}
	
	function resetMapSize() {
		$(".full-map").height(document.documentElement.clientHeight);
	}
	
	// Marks an element as invalid. Takes a jQuery-ized DOM element as input.
	function markInvalid(element) {
		element.addClass('error');
	}
	
	// Marks an element as invalid. Takes a jQuery-ized DOM element as input.
	function markValid(element) {
		element.removeClass('error');
	}
	
	function resetLatLngValidity() {
		markValid($("#lat"));
		markValid($("#lng"));
		clearError();
	}
	
	function resetAddressValidity() {
		markValid($("#address"));
		clearError();
	}
	
	// Validates input and returns lat/lng object
	function latLngFormValidateAndParse() {
		resetLatLngValidity();
		var returnObj = null;
		
		var hasError = false;
		var latControl = $("#lat");
		var lat = latControl.val();
		if(!validateLat(lat)) {
			hasError = true;
			markInvalid(latControl);
		}
		
		var lngControl = $("#lng");
		var lng = lngControl.val();
		if(!validateLng(lng)) {
			hasError = true;
			markInvalid(lngControl);
		}
		
		if(hasError) {
			return null;
		} else {
			return {lat: +lat, lng: +lng};
		}
	}
	function latlngFormSubmit() {
		originPoint = latLngFormValidateAndParse();
		if(null == originPoint) return;		
		
		// Throw an ajax call to get the nearest fire station and distance, then add marker for fire station and set label for both points to distance in miles
		markRequestSendTime();
		$.ajax({
			type: 'GET',
			url: ROOT + "/fire-station/v1/coord?lat=" + originPoint.lat + "&lng=" + originPoint.lng,
			headers: {
				"kb-auth-token": authToken
			},
			contentType: 'text/plain'
		}).error(function(jqXHR, textStatus, errorThrown) {
			console.error("Could not get fire station distance: " + errorThrown);
			if(jqXHR.responseJSON && jqXHR.responseJSON.error) {
				console.error(jqXHR.responseJSON.error);
				showError(jqXHR.responseJSON.error);
				return;
			}
		}).done(function(data) {
			// console.log(data);
			markResponseReceivedTime();
			showStats();
			
			createOriginPointMarker(map, originPoint, data.distanceInMiles);
			var fireStationMarker = createFireStationPointMarker(map, data.fireDepartment, data.fireDepartment.name);
			drawLineBetween(originPoint, data.fireDepartment, map, "red");
			
			var infoWindow = new google.maps.InfoWindow({
	          content: fireStationResultToHtml(data)
	        });
			fireStationMarker.addListener('click', function() {
				infoWindow.open(map, fireStationMarker);
	        });
			
		});
	}
	
	function fireStationResultToHtml(result) {
		var html = "<b>" + result.fireDepartment.name + "</b>";
		html += "<br /><br /><table>";
		html += "<tr><td><b>Type:</b> </td><td>" + result.fireDepartment.organizationType + "</td></tr>";
		html += "<tr><td><b>Distance:</b> </td><td>" + result.distanceInMiles + "</td></tr>";
		html += "<tr><td><b>Driving Distance:</b> </td><td>" + result.drivingDistanceInMiles + "</td></tr>";
		html += "<tr><td><b>Driving Time:</b> </td><td>" + secondsToHumanReadable(result.drivingDurationInSeconds) + "</td></tr>";
		html += "<tr><td><b>Staff:</b> </td><td>" + result.fireDepartment.staffType + "</td></tr>";
		if(result.fireDepartment.careerFirefighterCount && result.fireDepartment.careerFirefighterCount > 0) {
			html += "<tr><td><b>Career firefighters:</b> </td><td>" + result.fireDepartment.careerFirefighterCount + "</td></tr>";
		}
		if(result.fireDepartment.paidPerCallFirefighterCount && result.fireDepartment.paidPerCallFirefighterCount > 0) {
			html += "<tr><td><b>PPC firefighters:</b> </td><td>" + result.fireDepartment.paidPerCallFirefighterCount + "</td></tr>";
		}
		if(result.fireDepartment.volunteerFirefighterCount && result.fireDepartment.volunteerFirefighterCount > 0) {
			html += "<tr><td><b>Volunteer firefighters:</b> </td><td>" + result.fireDepartment.volunteerFirefighterCount + "</td></tr>";
		}
		if(result.fireDepartment.paidCivilianCount && result.fireDepartment.paidCivilianCount > 0) {
			html += "<tr><td><b>Civilian employees:</b> </td><td>" + result.fireDepartment.paidCivilianCount + "</td></tr>";
		}
		if(result.fireDepartment.volunteerCivilianCount && result.fireDepartment.volunteerCivilianCount > 0) {
			html += "<tr><td><b>Civilian volunteers:</b> </td><td>" + result.fireDepartment.volunteerCivilianCount + "</td></tr>";
		}
		if(result.fireDepartment.website && result.fireDepartment.website.indexOf("http") == 1) {
			html += "<tr><td colspan='2'>" + result.fireDepartment.website + "</td></tr>";
		}
		html += "</table>";
		return html;
	}
	
	function secondsToHumanReadable(seconds) {
		var result = "";
		var d = new Date(seconds * 1000);
		if(d.getUTCHours() > 0) {
			result += d.getUTCHours() + " hour" + (d.getUTCHours() > 1 ? "s" : "");
		}
		if(d.getUTCMinutes() > 0) {
			result += d.getUTCMinutes() + " minute" + (d.getUTCMinutes() > 1 ? "s" : "");
		}
		if(result.length == 0) {
			result = "Less than a minute";
		}
		return result;
	}
	
	// Validates input and returns address string
	function addressFormValidateAndParse() {
		resetAddressValidity();
		
		var hasError = false;
		var addressControl = $("#address");
		var address = addressControl.val();
		if(!address || address.length <= 3) {
			// No way this is a valid address
			hasError = true;
			markInvalid(addressControl);
		}
		
		if(hasError) {
			return null;
		} else {
			return address;
		}
	}
	function addressFormSubmit() {
		var address = addressFormValidateAndParse();
		
		if(null == address) return;		
		
		// Throw an ajax call to geolocate and get the nearest fire station point and distance
		markRequestSendTime();
		$.ajax({
			type: 'GET',
			url: ROOT + "/fire-station/v1/address?address=" + address,
			headers: {
				"kb-auth-token": authToken
			},
			contentType: 'text/plain'
		}).error(function(jqXHR, textStatus, errorThrown) {
			console.error("Could not get fire station distance for address: " + errorThrown);
			if(jqXHR.responseJSON && jqXHR.responseJSON.error) {
				console.error(jqXHR.responseJSON.error);
				showError(jqXHR.responseJSON.error);
				return;
			}
		}).done(function(data) { 
			// console.log(data);
			markResponseReceivedTime();
			showStats();
			
			if(data.error) {
				showError(data.error);
				return;
			}
			
			createOriginPointMarker(map, data.targetPoint, data.distanceInMiles);
			var fireStationMarker = createFireStationPointMarker(map, data.fireDepartment, data.fireDepartment.name);
			
			drawLineBetween(data.targetPoint, data.fireDepartment, map, "red");
			
			var infoWindow = new google.maps.InfoWindow({
	          content: fireStationResultToHtml(data)
	        });
			fireStationMarker.addListener('click', function() {
				infoWindow.open(map, fireStationMarker);
	        });
		});
	}
	
	function round(num) {
		return Math.round(num * 100) / 100;
	}
	
	function roundToThreePlaces(num) {
		return Math.round(num * 1000) / 1000;
	}
	
	function validateLatIncremental(e) {
		e = e||window.event; // IE support
		var c = (e.keyCode ? e.keyCode : e.which);
		var ctrlDown = e.ctrlKey||e.metaKey; // Mac support

		// Prevent upper-case characters (symbols on number keys)
		if(e.keyIdentifier && e.keyIdentifier === "Shift") return false;
		
		// Check for Alt+Gr (http://en.wikipedia.org/wiki/AltGr_key)
		if (ctrlDown && e.altKey) return true;

		// Check for ctrl+c, v and x
		if (ctrlDown && c==67) return true; // c
		if (ctrlDown && c==86) return true; // v
		if (ctrlDown && c==88) return true; // x
		if (ctrlDown && c==88) return true; // x
		if (ctrlDown && c==91) return true; // y
		if (ctrlDown && c==90) return true; // z
		
		var code = String.fromCharCode((96 <= c && c <= 105)? c-48 : c);
		
		var element = $("#lat");
    	var val = element.val();
    	if(validateCoordinateCharacter(code)) {
    		return true;
    	}
    	return false;
    }
	
	function validateLngIncremental(e) {
		e = e||window.event; // IE support
		var c = (e.keyCode ? e.keyCode : e.which);
		var ctrlDown = e.ctrlKey||e.metaKey; // Mac support
		
		// Prevent upper-case characters (symbols on number keys)
		if(e.keyIdentifier && e.keyIdentifier === "Shift") return false;
		
		// Check for Alt+Gr (http://en.wikipedia.org/wiki/AltGr_key)
		if (ctrlDown && e.altKey) return true;

		// Check for ctrl+c, v and x
		if (ctrlDown && c==67) return true; // c
		if (ctrlDown && c==86) return true; // v
		if (ctrlDown && c==88) return true; // x
		if (ctrlDown && c==91) return true; // y
		if (ctrlDown && c==90) return true; // z
		
		
		var code = String.fromCharCode((96 <= c && c <= 105)? c-48 : c);
		
		var element = $("#lng");
    	var val = element.val();
    	if(validateCoordinateCharacter(code)) {
    		return true;
    	}
    	return false;
    }
	
	function showError(msg) {
		var errorElement = $("#errorMessage");
		errorElement.html(msg);
		errorElement.show();
	}
	
	function clearError(msg) {
		var errorElement = $("#errorMessage");
		errorElement.hide();
		errorElement.html("");
	}
	
	var responseTimeMs = 0;
	var requestSendTime;
	function markRequestSendTime() {
		requestSendTime = new Date().getTime();
	}
	
	var responseReceivedTime;
	function markResponseReceivedTime() {
		responseReceivedTime = new Date().getTime();
		responseTimeMs = responseReceivedTime - requestSendTime;
	}
	
	function getResponseTimeMs() { return responseTimeMs; }
	
	function showResponseTime() {
		$("#stats .responseTime").text("Time: " + responseTimeMs + "ms");
	}
	
	function showStats() {
		showResponseTime();
	}

	$( document ).ready(function() {
		googleMapLibraryLoaded();
		$("#lat, #lng").on("keydown",function search(e) {
		    if(e.keyCode == 13) {
		        $("#go").click();
		    }
	    });
		$("#address").on("keydown",function search(e) {
		    if(e.keyCode == 13) {
		        $("#address-go").click();
		    }
	    });
	});
    </script>

	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-106137563-1"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'UA-106137563-1');
	</script>
</body>

</html>
