<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="KB GeoRisk distance to coast calculation demonstration">
    <meta name="author" content="Steve Perkins, KB GeoRisk">

    <title>KB GeoRisk</title>

    <!-- Bootstrap Core CSS -->
    <link href="css/bootstrap.min.css" rel="stylesheet">

    <!-- Custom CSS -->
    <link href="css/simple-sidebar.css" rel="stylesheet">
	
	<link href="css/kbgeo.css" rel="stylesheet">
	
    <!-- HTML5 Shim and Respond.js IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
        <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
        <script src="https://oss.maxcdn.com/libs/respond.js/1.4.2/respond.min.js"></script>
    <![endif]-->

</head>

<body>
    <div id="wrapper" class="toggled">
    	<img src="img/cic-logo.png" style="position: absolute;top: 0;right: 0;z-index: 1;"/>
        <!-- Sidebar -->
        <div id="sidebar-wrapper">
            <ul class="sidebar-nav">
                <li class="sidebar-brand">
                    <a href="http://www.kbgeo.com">
                       <img src="img/kbgeo-logo.png" /> KB GeoRisk
                    </a>
                </li>
                <!-- 
                <li>
                    <a href="learnmore.html">Learn more...</a>
                </li>
				 -->
				 
				<!--
                <li>
                    <a href="#">Shortcuts</a>
                </li>
                <li>
                    <a href="#">Overview</a>
                </li>
                <li>
                    <a href="#">Events</a>
                </li>
                <li>
                    <a href="#">About</a>
                </li>
                <li>
                    <a href="#">Services</a>
                </li>
				-->
			</ul>
			
			
            <ul class="nav nav-tabs" role="tablist">
			    <li role="presentation" class="active"><a href="#latlng" aria-controls="latlng" role="tab" data-toggle="tab">Lat/Lng</a></li>
			    <li role="presentation"><a href="#addressTab" aria-controls="addressTab" role="tab" data-toggle="tab">Address</a></li>
			  </ul>
			
			  <!-- Tab panes -->
			  <div class="tab-content">
			    <div role="tabpanel" class="tab-pane active" id="latlng">
			    	<div class="form">
					  <div class="form-group">
						<label for="lat">Lat:</label>
						<input type="text" class="form-control" id="lat" placeholder="Latitude" value="39.768403" onkeydown="return validateLatIncremental(event);">
					  </div>
					  <div class="form-group">
						<label for="lng">Lon:</label>
						<input type="text" class="form-control" id="lng" placeholder="Longitude" value="-86.158068" onkeydown="return validateLngIncremental(event);">
					  </div>
					  <button id="go" type="button" class="btn btn-primary center-block" onclick="latlngFormSubmit();return">Go!</button>
				  </div>
				</div>
			    <div role="tabpanel" class="tab-pane" id="addressTab">
			    	<div class="form">
					  <div class="form-group">
						<label for="address">Address:</label>
						<input type="text" class="form-control" id="address" placeholder="Full address" value="">
					  </div>
					  <button id="address-go" type="button" class="btn btn-primary center-block" onclick="addressFormSubmit();return">Go!</button>
				  </div>
			    </div>
			    <div class="form-group">
					<label for="authToken">Token:</label>
					<input type="text" class="form-control" id="authToken" placeholder="Auth token">
				</div>
			    <div style="text-align: center">
			    	<span id="errorMessage"></span>
			    </div>
			  </div>
			<div id="stats">
				<span class="responseTime"></span>
			</div>
            <div id="footer">
            	KB GeoRisk provides <strong>blazing-fast</strong>, <strong>highly-accurate</strong>, <strong>low-cost</strong> distance to coast calculation for insurance risk and other industries.
            	<div style="margin-top: 20px">
	            	<img src="img/firefox.png" /> <a id="firefox-warning" href="#" style="color: white">Firefox user?</a>
	            	<div id="firefox-warning-text" style="display: none">Firefox's March 2015 update disables CORS support. You may need to change your Firefox settings to enable CORS or use another browser.</div>
            	</div>
            </div>
        </div>
        <!-- /#sidebar-wrapper -->

        <!-- Page Content -->
        <div id="page-content-wrapper">
		<div id="mainMap" class="full-map"></div>
        </div>
        <!-- /#page-content-wrapper -->

    </div>
    <!-- /#wrapper -->

    <!-- jQuery -->
    <script src="js/jquery.js"></script>

    <!-- Bootstrap Core JavaScript -->
    <script src="js/bootstrap.min.js"></script>
    
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCByV51ctBx5oDi6cbXTnfN7eBR2rUMGpE"></script>
    <script src="js/markerwithlabel.js"></script>
	
	<script src="js/validator.js"></script>
	<script src="js/maps.js"></script>
	
    <!-- Menu Toggle Script -->
    <script>
	var ROOT = "https://api.kbgeo.com";
	// var ROOT = "http://localhost:8080/api";
	var map;
	var originPoint;
	var coastalPoint;
	
	$(window).on('resize orientationChange', function(event) {
		resetMapSize();
	});
	
    $("#menu-toggle").click(function(e) {
        e.preventDefault();
        $("#wrapper").toggleClass("toggled");
    });
    
    $("#firefox-warning").click(function(e) {
        e.preventDefault();
        $("#firefox-warning-text").toggle();
    });
    
    
	
	function googleMapLibraryLoaded() {
		setTimeout(function() {$("#wrapper").toggleClass("toggled");}, 1);
		resetMapSize();
		map = initMap('mainMap');
	}
	
	function resetMapSize() {
		$(".full-map").height(document.documentElement.clientHeight);
	}
	
	// Marks an element as invalid. Takes a jQuery-ized DOM element as input.
	function markInvalid(element) {
		element.addClass('error');
	}
	
	// Marks an element as invalid. Takes a jQuery-ized DOM element as input.
	function markValid(element) {
		element.removeClass('error');
	}
	
	function resetLatLngValidity() {
		markValid($("#lat"));
		markValid($("#lng"));
		clearError();
	}
	
	function resetAddressValidity() {
		markValid($("#address"));
		clearError();
	}
	
	// Validates input and returns lat/lng object
	function latLngFormValidateAndParse() {
		resetLatLngValidity();
		var returnObj = null;
		
		var hasError = false;
		var latControl = $("#lat");
		var lat = latControl.val();
		if(!validateLat(lat)) {
			hasError = true;
			markInvalid(latControl);
		}
		
		var lngControl = $("#lng");
		var lng = lngControl.val();
		if(!validateLng(lng)) {
			hasError = true;
			markInvalid(lngControl);
		}
		
		if(hasError) {
			return null;
		} else {
			return {lat: +lat, lng: +lng};
		}
	}
	function latlngFormSubmit() {
		originPoint = latLngFormValidateAndParse();
		if(null == originPoint) return;		
		
		// Throw an ajax call to get the nearest coastal point and distance, then add marker for coastal point and set label for both points to distance in miles
		$.ajax({
			type: 'GET',
			url: ROOT + "/coastal-distance/v1/coord?lat=" + originPoint.lat + "&lng=" + originPoint.lng,
			headers: {
				"kb-auth-token": $("#authToken").val()
			},
			contentType: 'text/plain'
		}).error(function(jqXHR, textStatus, errorThrown) {
			console.error("Could not get coastal distance: " + errorThrown);
			if(jqXHR.responseJSON && jqXHR.responseJSON.error) {
				console.error(jqXHR.responseJSON.error);
				showError(jqXHR.responseJSON.error);
				return;
			}
		}).done(function(data) {
			createOriginPointMarker(map, data.targetPoint, data.distanceInMiles);
			
			coastalPoint = data.coastlinePoint;
			createCoastalPointMarker(map, coastalPoint);
			
			drawLineBetween(originPoint, coastalPoint, map);
		});
	}
	
	
	// Validates input and returns address string
	function addressFormValidateAndParse() {
		resetAddressValidity();
		
		var hasError = false;
		var addressControl = $("#address");
		var address = addressControl.val();
		if(!address || address.length <= 3) {
			// No way this is a valid address
			hasError = true;
			markInvalid(addressControl);
		}
		
		if(hasError) {
			return null;
		} else {
			return address;
		}
	}
	function addressFormSubmit() {
		var address = addressFormValidateAndParse();
		
		if(null == address) return;		
		
		// Throw an ajax call to geolocate and get the nearest coastal point and distance
		$.ajax({
			type: 'GET',
			url: ROOT + "/coastal-distance/v1/address?address=" + address,
			headers: {
				"kb-auth-token":  $("#authToken").val()
			},
			contentType: 'text/plain'
		}).error(function(jqXHR, textStatus, errorThrown) {
			console.error("Could not get coastal distance for address: " + errorThrown);
			if(jqXHR.responseJSON && jqXHR.responseJSON.error) {
				console.error(jqXHR.responseJSON.error);
				showError(jqXHR.responseJSON.error);
				return;
			}
		}).done(function(data) { 
			if(data.error) {
				showError(data.error);
				return;
			}
			
			createOriginPointMarker(map, data.targetPoint, data.distanceInMiles);
			createCoastalPointMarker(map, data.coastlinePoint);
			
			drawLineBetween(data.targetPoint, data.coastlinePoint, map);
		});
	}
	
	function round(num) {
		return Math.round(num * 100) / 100;
	}
	
	function roundToThreePlaces(num) {
		return Math.round(num * 1000) / 1000;
	}
	
	function validateLatIncremental(e) {
		e = e||window.event; // IE support
		var c = (e.keyCode ? e.keyCode : e.which);
		var ctrlDown = e.ctrlKey||e.metaKey; // Mac support

		// Prevent upper-case characters (symbols on number keys)
		if(e.keyIdentifier && e.keyIdentifier === "Shift") return false;
		
		// Check for Alt+Gr (http://en.wikipedia.org/wiki/AltGr_key)
		if (ctrlDown && e.altKey) return true;

		// Check for ctrl+c, v and x
		if (ctrlDown && c==67) return true; // c
		if (ctrlDown && c==86) return true; // v
		if (ctrlDown && c==88) return true; // x
		if (ctrlDown && c==88) return true; // x
		if (ctrlDown && c==91) return true; // y
		if (ctrlDown && c==90) return true; // z
		
		var code = String.fromCharCode((96 <= c && c <= 105)? c-48 : c);
		
		var element = $("#lat");
    	var val = element.val();
    	if(validateCoordinateCharacter(code)) {
    		return true;
    	}
    	return false;
    }
	
	function validateLngIncremental(e) {
		e = e||window.event; // IE support
		var c = (e.keyCode ? e.keyCode : e.which);
		var ctrlDown = e.ctrlKey||e.metaKey; // Mac support
		
		// Prevent upper-case characters (symbols on number keys)
		if(e.keyIdentifier && e.keyIdentifier === "Shift") return false;
		
		// Check for Alt+Gr (http://en.wikipedia.org/wiki/AltGr_key)
		if (ctrlDown && e.altKey) return true;

		// Check for ctrl+c, v and x
		if (ctrlDown && c==67) return true; // c
		if (ctrlDown && c==86) return true; // v
		if (ctrlDown && c==88) return true; // x
		if (ctrlDown && c==91) return true; // y
		if (ctrlDown && c==90) return true; // z
		
		
		var code = String.fromCharCode((96 <= c && c <= 105)? c-48 : c);
		
		var element = $("#lng");
    	var val = element.val();
    	if(validateCoordinateCharacter(code)) {
    		return true;
    	}
    	return false;
    }
	
	function showError(msg) {
		var errorElement = $("#errorMessage");
		errorElement.html(msg);
		errorElement.show();
	}
	
	function clearError(msg) {
		var errorElement = $("#errorMessage");
		errorElement.hide();
		errorElement.html("");
	}
	
	$( document ).ready(function() {
		googleMapLibraryLoaded();
		$("#lat, #lng").on("keydown",function search(e) {
		    if(e.keyCode == 13) {
		        $("#go").click();
		    }
	    });
		$("#address").on("keydown",function search(e) {
		    if(e.keyCode == 13) {
		        $("#address-go").click();
		    }
	    });
	});
    </script>

</body>

</html>
